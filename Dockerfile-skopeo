# Skopeo sidecar: runs Skopeo in a separate container and exposes a small HTTP server
# so the main app (no Skopeo installed) can call it via POST /run.
#
# Uses Chainguard (cgr.dev) base images for minimal CVEs and supply-chain hardening.
# Multi-stage: copy skopeo binary from Chainguard skopeo image into Chainguard Python runtime.
# Replace "chainguard" with your Chainguard org (e.g. dominodatalab.com) if using a private registry.
#
# For digest pinning (recommended): use @sha256:... instead of :latest for reproducible builds.
# If the copied binary fails at runtime (e.g. missing shared libs), use an Alpine-based build
# instead: FROM alpine:3.19 / RUN apk add --no-cache skopeo python3 / COPY server / CMD.
# ------------------------------------------------
FROM cgr.dev/dominodatalab.com/skopeo:1.21.0 AS skopeo
FROM cgr.dev/dominodatalab.com/python:3.14.2

# Copy skopeo binary from Chainguard skopeo image (Wolfi-based; compatible with Chainguard Python)
COPY --from=skopeo --chown=nonroot:nonroot /usr/bin/skopeo /usr/bin/skopeo

COPY --chown=nonroot:nonroot python/scripts/skopeo_sidecar_server.py /server.py

ENV SKOPEO_SIDECAR_PORT=8080
EXPOSE 8080

# Run as nonroot for least privilege (port 8080 does not require root)
USER nonroot:nonroot

CMD ["/server.py"]

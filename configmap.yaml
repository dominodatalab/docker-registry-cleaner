apiVersion: v1
kind: ConfigMap
metadata:
  name: docker-registry-cleaner-config
  namespace: domino-platform
data:
  config.yaml: |
    # Docker Registry Cleaner Configuration
    # This file contains shared configuration for all scripts

    # Registry Configuration
    registry:
      url: "test.quay.io"
      repository: "domino"

    # Kubernetes Configuration
    kubernetes:
      domino_platform_namespace: "domino-platform"

    # Mongo Configuration
    mongo:
      host: "mongodb-replicaset"
      port: 27017
      replicaset: "rs0"
      db: "domino"

    # Analysis Configuration
    analysis:
      max_workers: 4
      timeout: 300
      output_dir: "../reports"

    # Retry Configuration
    retry:
      max_retries: 3          # Maximum number of retry attempts for network operations
      initial_delay: 1.0      # Initial delay in seconds before first retry
      max_delay: 60.0         # Maximum delay between retries in seconds
      exponential_base: 2.0   # Base for exponential backoff (delay = initial_delay * (base ^ attempt))
      jitter: true            # Add random jitter to prevent thundering herd
      timeout: 300            # Timeout for subprocess calls in seconds

    # Cache Configuration
    cache:
      enabled: true           # Enable caching for expensive operations
      tag_list_ttl: 1800      # Tag list cache TTL in seconds (30 minutes)
      tag_list_max_size: 100  # Maximum number of cached tag lists
      image_inspect_ttl: 3600 # Image inspection cache TTL in seconds (1 hour)
      image_inspect_max_size: 1000  # Maximum number of cached image inspections
      mongo_query_ttl: 600    # MongoDB query cache TTL in seconds (10 minutes)
      mongo_query_max_size: 500  # Maximum number of cached MongoDB queries
      layer_calc_ttl: 7200    # Layer calculation cache TTL in seconds (2 hours)
      layer_calc_max_size: 2000  # Maximum number of cached layer calculations
    # S3 Backup Configuration
    s3:
      bucket: ""  # S3 bucket for image backups (optional, can be set via --s3-bucket flag)
      region: "eu-west-1"  # AWS region for S3 and ECR operations

    # Skopeo Configuration
    skopeo:
      use_pod: false  # Set to true to run Skopeo commands in Kubernetes pod instead of local subprocess
      rate_limit:
        enabled: true  # Enable rate limiting for registry operations
        requests_per_second: 10.0  # Maximum requests per second (adjust based on registry capacity)
        burst_size: 20  # Allow burst of up to N requests (helps with parallel operations)

    # Default Report Paths
    reports:
      archived_tags: "archived-tags.json"
      deletion_analysis: "deletion-analysis.json"
      filtered_layers: "filtered-layers.json"
      image_analysis: "final-report.json"
      images_report: "images-report"
      layers_and_sizes: "layers-and-sizes.json"
      mongodb_usage: "mongodb_usage_report.json"
      tags_per_layer: "tags-per-layer.json"
      tag_sums: "tag-sums.json"
      unused_references: "unused-references.json"

    # Security Configuration
    security:
      dry_run_by_default: true
      require_confirmation: true 



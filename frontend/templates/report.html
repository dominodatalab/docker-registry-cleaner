{% extends "base.html" %}

{% block title %}{{ filename }} - Docker Registry Cleaner{% endblock %}

{% block extra_css %}
<style>
    .json-viewer {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 20px;
        border-radius: 4px;
        overflow-x: auto;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
    }
    .json-viewer pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
    }
    .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #0066cc;
        margin: 10px 0;
    }
    .stat-label {
        font-size: 0.9em;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .tabs {
        display: flex;
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 20px;
    }
    .tab {
        padding: 12px 24px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 16px;
        color: #666;
        transition: all 0.3s;
    }
    .tab.active {
        color: #0066cc;
        border-bottom: 3px solid #0066cc;
        margin-bottom: -2px;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <a href="{{ url_for('index') }}" class="back-link">‚Üê Back to Reports</a>
    <h2>{{ filename }}</h2>
</div>

<div class="tabs">
    <button class="tab active" onclick="switchTab('summary')">Summary</button>
    <button class="tab" onclick="switchTab('raw')">Raw JSON</button>
</div>

<div id="summary-tab" class="tab-content active">
    <div id="report-summary">
        <div class="loading">Loading report summary...</div>
    </div>
</div>

<div id="raw-tab" class="tab-content">
    <div class="json-viewer">
        <pre>{{ report_data }}</pre>
    </div>
</div>

<script>
const reportData = {{ report_data | safe }};
const reportType = "{{ report_type }}";
const filename = "{{ filename }}";

function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');

    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(tabName + '-tab').classList.add('active');
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function renderSummary() {
    const summaryDiv = document.getElementById('report-summary');
    let html = '';

    if (reportType === 'size_report') {
        html = renderSizeReport(reportData);
    } else if (reportType === 'mongodb_usage') {
        html = renderMongoDBUsageReport(reportData);
    } else if (reportType === 'archived_tags') {
        html = renderArchivedTagsReport(reportData);
    } else if (reportType === 'unused_environments') {
        html = renderUnusedEnvironmentsReport(reportData);
    } else if (reportType === 'deletion_results') {
        html = renderDeletionResultsReport(reportData);
    } else if (reportType === 'final_report') {
        html = renderFinalReport(reportData);
    } else {
        html = renderGenericReport(reportData);
    }

    summaryDiv.innerHTML = html;
}

function renderSizeReport(data) {
    let html = '<div class="stats-grid">';

    if (data.total_size_bytes) {
        html += `<div class="stat-card">
            <div class="stat-label">Total Size</div>
            <div class="stat-value">${formatBytes(data.total_size_bytes)}</div>
        </div>`;
    }

    if (data.total_images) {
        html += `<div class="stat-card">
            <div class="stat-label">Total Images</div>
            <div class="stat-value">${data.total_images}</div>
        </div>`;
    }

    html += '</div>';

    // Show top items
    if (data.images || data.users) {
        html += '<h3>Top Items</h3><div class="table-wrapper"><table class="data-table">';
        html += '<thead><tr><th>Name</th><th>Size</th><th>Count</th></tr></thead><tbody>';

        const items = data.images || data.users || [];
        items.slice(0, 20).forEach(item => {
            html += `<tr>
                <td>${item.name || item.user || item.image_name || 'Unknown'}</td>
                <td>${formatBytes(item.size_bytes || item.total_size_bytes || 0)}</td>
                <td>${item.count || item.image_count || '-'}</td>
            </tr>`;
        });

        html += '</tbody></table></div>';
    }

    return html;
}

function renderMongoDBUsageReport(data) {
    let html = '<div class="stats-grid">';

    if (data.summary) {
        const s = data.summary;
        if (s.total_environments !== undefined) {
            html += `<div class="stat-card">
                <div class="stat-label">Total Environments</div>
                <div class="stat-value">${s.total_environments}</div>
            </div>`;
        }
        if (s.total_models !== undefined) {
            html += `<div class="stat-card">
                <div class="stat-label">Total Models</div>
                <div class="stat-value">${s.total_models}</div>
            </div>`;
        }
        if (s.total_runs !== undefined) {
            html += `<div class="stat-card">
                <div class="stat-label">Total Runs</div>
                <div class="stat-value">${s.total_runs}</div>
            </div>`;
        }
    }

    html += '</div>';
    return html;
}

function renderArchivedTagsReport(data) {
    let html = '<div class="stats-grid">';

    if (data.summary) {
        const s = data.summary;
        if (s.total_archived !== undefined) {
            html += `<div class="stat-card">
                <div class="stat-label">Total Archived</div>
                <div class="stat-value">${s.total_archived}</div>
            </div>`;
        }
        if (s.space_to_free_bytes !== undefined) {
            html += `<div class="stat-card">
                <div class="stat-label">Space to Free</div>
                <div class="stat-value">${formatBytes(s.space_to_free_bytes)}</div>
            </div>`;
        }
    }

    html += '</div>';

    if (data.archived_items) {
        html += '<h3>Archived Items</h3><div class="table-wrapper"><table class="data-table">';
        html += '<thead><tr><th>Type</th><th>Tag</th><th>Size</th></tr></thead><tbody>';

        data.archived_items.slice(0, 50).forEach(item => {
            html += `<tr>
                <td>${item.image_type || 'Unknown'}</td>
                <td>${item.tag || item.image_tag || '-'}</td>
                <td>${formatBytes(item.size_bytes || 0)}</td>
            </tr>`;
        });

        html += '</tbody></table></div>';
    }

    return html;
}

function renderUnusedEnvironmentsReport(data) {
    let html = '<div class="stats-grid">';

    if (data.summary) {
        const s = data.summary;
        if (s.total_unused !== undefined) {
            html += `<div class="stat-card">
                <div class="stat-label">Total Unused</div>
                <div class="stat-value">${s.total_unused}</div>
            </div>`;
        }
    }

    html += '</div>';
    return html;
}

function renderDeletionResultsReport(data) {
    let html = '<div class="stats-grid">';

    if (data.deleted_count !== undefined) {
        html += `<div class="stat-card">
            <div class="stat-label">Deleted</div>
            <div class="stat-value">${data.deleted_count}</div>
        </div>`;
    }

    if (data.failed_count !== undefined) {
        html += `<div class="stat-card">
            <div class="stat-label">Failed</div>
            <div class="stat-value">${data.failed_count}</div>
        </div>`;
    }

    if (data.freed_space_bytes !== undefined) {
        html += `<div class="stat-card">
            <div class="stat-label">Space Freed</div>
            <div class="stat-value">${formatBytes(data.freed_space_bytes)}</div>
        </div>`;
    }

    html += '</div>';
    return html;
}

function renderFinalReport(data) {
    let html = '<div class="stats-grid">';

    if (data.total_images !== undefined) {
        html += `<div class="stat-card">
            <div class="stat-label">Total Images</div>
            <div class="stat-value">${data.total_images}</div>
        </div>`;
    }

    if (data.total_size_bytes !== undefined) {
        html += `<div class="stat-card">
            <div class="stat-label">Total Size</div>
            <div class="stat-value">${formatBytes(data.total_size_bytes)}</div>
        </div>`;
    }

    if (data.total_layers !== undefined) {
        html += `<div class="stat-card">
            <div class="stat-label">Total Layers</div>
            <div class="stat-value">${data.total_layers}</div>
        </div>`;
    }

    html += '</div>';
    return html;
}

function renderGenericReport(data) {
    // Extract some generic stats
    let html = '<div class="info-box">';
    html += '<h3>Report Data</h3>';
    html += '<p>This report contains ' + Object.keys(data).length + ' top-level fields.</p>';
    html += '<p>View the Raw JSON tab for complete details.</p>';
    html += '</div>';
    return html;
}

// Render summary on load
renderSummary();
</script>
{% endblock %}
